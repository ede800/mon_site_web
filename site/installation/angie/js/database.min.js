/*
 Copyright (c)2009-2022 Nicholas K. Dionysopoulos / Akeeba Ltd
 @license   GNU General Public License version 3, or later
*/
var databaseKey=null,databaseThrottle=100,databasePasswordMessage="",databasePrefixMessage="",databaseHasWarnings=!1,databaseLogFile="",databaseResumeRetry=0,databaseResumeTimer=null;function toggleHelp(){for(var a=document.querySelectorAll(".akeeba-help-text"),b=0;b<a.length;b++){var c=a[b];c.style.display="none"===c.style.display?"block":"none"}}
function databaseRunRestoration(a){databaseKey=a;a={view:"dbrestore",task:"start",format:"json",key:databaseKey,dbinfo:{}};a.dbinfo.dbtype=document.getElementById("dbtype").value;a.dbinfo.dbhost=document.getElementById("dbhost").value;a.dbinfo.dbuser=document.getElementById("dbuser").value;a.dbinfo.dbpass=document.getElementById("dbpass").value;a.dbinfo.dbname=document.getElementById("dbname").value;a.dbinfo.prefix=document.getElementById("prefix").value;a.dbinfo.existing=document.getElementById("existing").value;
a.dbinfo.foreignkey=+document.getElementById("foreignkey").checked;a.dbinfo.noautovalue=+document.getElementById("noautovalue").checked;a.dbinfo.replace=+document.getElementById("replace").checked;a.dbinfo.utf8db=+document.getElementById("utf8db").checked;a.dbinfo.utf8tables=+document.getElementById("utf8tables").checked;a.dbinfo.utf8mb4=+document.getElementById("utf8mb4").checked;a.dbinfo.break_on_failed_create=+document.getElementById("break_on_failed_create").checked;a.dbinfo.break_on_failed_insert=
+document.getElementById("break_on_failed_insert").checked;a.dbinfo.maxexectime=document.getElementById("maxexectime").value;a.dbinfo.throttle=document.getElementById("throttle").value;var b=document.getElementById("specific_tables");if(b){for(var c=[],d=0;d<b.length;d++)b.options[d].selected&&c.push(b.options[d].value);a.specific_tables=c}if(!databasePrefixMessage.length||!1===/[A-Z]{1,}/.test(a.dbinfo.prefix)||window.confirm(databasePrefixMessage))if(!databasePasswordMessage.length||!1!==/^[a-zA-Z0-9- ]*$/.test(a.dbinfo.dbpass)||
window.confirm(databasePasswordMessage))document.getElementById("restoration-progress-bar").style.width="0%",document.getElementById("restoration-progress-bar-text").innerText="0%",document.getElementById("restoration-lbl-restored").innerText="",document.getElementById("restoration-lbl-total").innerText="",document.getElementById("restoration-lbl-eta").innerText="",document.getElementById("restoration-progress").style.display="block",document.getElementById("restoration-success").style.display="none",
document.getElementById("restoration-error").style.display="none",document.getElementById("restoration-retry").style.display="none",akeeba.Modal.open({inherit:"#restoration-dialog",width:"80%",lock:!0}),databaseResumeRetry=0,databaseHasWarnings=!1,databaseLogFile="",document.getElementById("restoration-warnings").style.display="none",akeebaAjax.callJSON(a,databaseParseRestoration,databaseEndWithErrorRestoration)}
function databaseParseRestoration(a){""!=a.error?databaseErrorRestoration(a.error):1==a.done?(document.getElementById("restoration-progress").style.display="none",document.getElementById("restoration-success").style.display="block",document.getElementById("restoration-error").style.display="none",document.getElementById("restoration-retry").style.display="none",document.getElementById("restoration-success-nowarnings").style.display="block",document.getElementById("restoration-success-warnings").style.display=
"none",databaseHasWarnings&&(document.getElementById("restoration-success-nowarnings").style.display="hide",document.getElementById("restoration-success-warnings").style.display="show",document.getElementById("restoration-sql-log").innerText=databaseLogFile)):(document.getElementById("restoration-progress").style.display="block",document.getElementById("restoration-success").style.display="none",document.getElementById("restoration-error").style.display="none",document.getElementById("restoration-progress-bar").style.width=
a.percent+"%",document.getElementById("restoration-progress-bar-text").innerText=a.percent+"%",document.getElementById("restoration-lbl-restored").innerText=a.restored,document.getElementById("restoration-lbl-total").innerText=a.total,document.getElementById("restoration-lbl-eta").innerText=a.eta,!databaseHasWarnings&&0<a.errorcount&&(databaseHasWarnings=!0,databaseLogFile=a.errorlog,document.getElementById("restoration-warnings").style.display="block",document.getElementById("restoration-inprogress-log").innerText=
databaseLogFile),setTimeout(databaseStepRestoration,databaseThrottle))}function databaseStepRestoration(){akeebaAjax.callJSON({view:"dbrestore",task:"step",format:"json",key:databaseKey},databaseParseRestoration,databaseErrorRestoration)}
function databaseErrorRestoration(a){3<databaseResumeRetry?databaseEndWithErrorRestoration(a):(databaseResumeRetry++,resetRetryTimeoutBar(),document.getElementById("restoration-progress").style.display="none",document.getElementById("restoration-success").style.display="none",document.getElementById("restoration-error").style.display="none",document.getElementById("restoration-error-message-retry").textContent=a,document.getElementById("restoration-retry").style.display="block",startRetryTimeoutBar())}
function databaseEndWithErrorRestoration(a){document.getElementById("restoration-progress").style.display="none";document.getElementById("restoration-success").style.display="none";document.getElementById("restoration-error").style.display="block";document.getElementById("restoration-retry").style.display="none";document.getElementById("restoration-lbl-error").innerHTML=a;document.getElementById("akeeba-modal-close").style.visibility="visible"}
function databaseBtnSuccessClick(a){window.location=document.getElementById("btnSkip").href}function cancelResume(){resetRetryTimeoutBar();var a=document.getElementById("restoration-error-message-retry").innerHTML;databaseEndWithErrorRestoration(a);return!1}
function resumeRestoration(){resetRetryTimeoutBar();document.getElementById("restoration-error").style.display="none";document.getElementById("restoration-retry").style.display="none";document.getElementById("restoration-progress").style.display="block";databaseStepRestoration();return!1}function resetRetryTimeoutBar(){clearInterval(databaseResumeTimer);document.getElementById("akeeba-retry-timeout").textContent="30"}
function startRetryTimeoutBar(){var a=30;databaseResumeTimer=setInterval(function(){a--;document.getElementById("akeeba-retry-timeout").textContent=a.toFixed(0);0==a&&(clearInterval(databaseResumeTimer),resumeRestoration())},1E3)}
function toggleSpecificTables(){var a=document.getElementById("specific_tables_cbx");if(a){a.addEventListener("click",function(){var c=document.getElementById("specific_tables");if(this.checked)$("#specific_tables_holder").show(),$("#specific_tables").chosen();else{c=c.options;for(var d=0;d<c.length;d++)c[d].selected=!1;$("#specific_tables_holder").hide();$("#specific_tables").chosen("destroy")}});a=document.getElementById("specific_tables_addall");var b=document.getElementById("specific_tables_clearall");
a.addEventListener("click",function(){$("#specific_tables option").prop("selected",!0);$("#specific_tables").chosen().trigger("chosen:updated")});b.addEventListener("click",function(){$("#specific_tables option:selected").removeAttr("selected");$("#specific_tables").chosen().trigger("chosen:updated")})}}
akeeba.System.documentReady(function(){toggleSpecificTables();document.getElementById("restoration-cancel-resume").addEventListener("click",cancelResume);document.getElementById("restoration-resume").addEventListener("click",resumeRestoration)});
